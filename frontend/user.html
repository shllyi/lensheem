<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>User Management</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap4.min.css"
    integrity="sha512-PT0RvABaDhDQugEbpNMwgYBCnGCiTZMh9yOzUsJHDgl/dMhD9yjHAwoumnUk3JydV3QTcIkNDuN40CJxik5+WQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/buttons/2.3.5/css/buttons.dataTables.min.css" rel="stylesheet" />

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-buttons-bs5/2.3.6/buttons.bootstrap5.min.css"
    integrity="sha512-vWTrt2A9iAn2pK8hNZS26YZRDDUvLiOfyL+MmBEXJizrigtxnpLuLrLOOMm+pcrUJFzGssUwoS6Gofp+TT2deQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.css"
    integrity="sha512-fjO3Vy3QodX9c6G9AUmr6WuIaEPdGRxBjD7gjatG5gGylzYyrEq3U0q+smkG6CwIY0L8XALRFHh4KPHig0Q1ug=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"
    integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"
    integrity="sha512-BkpSL20WETFylMrcirBahHfSnY++H2O1W+UnEEO4yNIl+jI2+zowyoGJpbtk6bx97fBXf++WJHSSK2MV4ghPcg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.5/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.5/js/buttons.bootstrap4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"
    integrity="sha512-RdSPYh1WA6BF0RhpisYJVYkOyTzK4HwofJ3Q7ivt/jkpW6Vc8AurL1R+4AUcvn9IwEKAPm/fk7qFZW3OuiUDeg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.js"
    integrity="sha512-L0Shl7nXXzIlBSUUPpxrokqq4ojqgZFQczTYlGjzONGTDAcLremjwaWv5A+EDLnxhQzY5xUZPWLOLqYRkY0Cbw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js"
    integrity="sha512-LGHBR+kJ5jZSIzhhdfytPoEHzgaYuTRifq9g5l6ja6/k9NAOsAi5dQh4zQF6JIRB8cAYxTRedERUF+97/KuivQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="assets/js/user.js"></script>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>

<body>
  <div class="container-fluid py-4">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">User Management</h3>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <button class="btn btn-success" id="addUserBtn">
            <i class="fas fa-plus"></i> Add New User
          </button>
          <button class="btn btn-info ml-2" id="toggleDeletedBtn">
            <i class="fas fa-eye"></i> Show Deleted Users
          </button>
        </div>
        <div class="table-responsive">
          <table id="utable" class="table table-striped table-bordered table-hover" style="width:100%">
            <thead class="thead-dark">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Profile</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Users will load here dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <form id="uform">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userModalLabel">User Form</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="user_name">Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="user_name" name="name" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="user_email">Email <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" id="user_email" name="email" required>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="user_password">Password <span class="text-danger">*</span></label>
                  <input type="password" class="form-control" id="user_password" name="password" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="user_confirm_password">Confirm Password <span class="text-danger">*</span></label>
                  <input type="password" class="form-control" id="user_confirm_password" name="confirm_password" required>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="userSubmit">Save</button>
            <button type="button" class="btn btn-success" id="userUpdate" style="display: none;">Update</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal fade" id="profileModal" tabindex="-1" role="dialog" aria-labelledby="profileModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="profileModalLabel">User Profile</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="profileContent">
            <!-- Profile content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      let table;
      let isEditMode = false;
      let currentUserId = null;
      let showDeleted = false;

      // Initialize DataTable
      function initDataTable() {
        table = $('#utable').DataTable({
          "ajax": {
            "url": "/api/users" + (showDeleted ? "?showDeleted=true" : ""),
            "dataSrc": "data"
          },
          "columns": [
            { "data": "id" },
            { "data": "name" },
            { "data": "email" },
            { 
              "data": null,
              "render": function(data, type, row) {
                return `<button class="btn btn-sm btn-info view-profile" data-id="${row.id}">
                          <i class="fas fa-user"></i> View Profile
                        </button>`;
              }
            },
            { 
              "data": "deleted_at",
              "render": function(data, type, row) {
                if (data) {
                  return '<span class="badge badge-danger">Deleted</span>';
                } else {
                  return '<span class="badge badge-success">Active</span>';
                }
              }
            },
            { 
              "data": "created_at",
              "render": function(data, type, row) {
                return data ? new Date(data).toLocaleDateString() : 'N/A';
              }
            },
            {
              "data": null,
              "render": function(data, type, row) {
                if (row.deleted_at) {
                  return `<button class="btn btn-sm btn-success restore-user" data-id="${row.id}">
                            <i class="fas fa-undo"></i> Restore
                          </button>`;
                } else {
                  return `<button class="btn btn-sm btn-warning edit-user" data-id="${row.id}">
                            <i class="fas fa-edit"></i> Edit
                          </button>
                          <button class="btn btn-sm btn-danger delete-user" data-id="${row.id}">
                            <i class="fas fa-trash"></i> Delete
                          </button>`;
                }
              }
            }
          ],
          "order": [[0, "desc"]],
          "responsive": true,
          "destroy": true
        });
      }

      // Initialize table on page load
      initDataTable();

      // Add User Button
      $('#addUserBtn').click(function() {
        $('#userModal').modal('show');
        $('#userModalLabel').text('Add New User');
        $('#uform')[0].reset();
        $('#userSubmit').show();
        $('#userUpdate').hide();
        isEditMode = false;
        currentUserId = null;
      });

      // Toggle Deleted Users
      $('#toggleDeletedBtn').click(function() {
        showDeleted = !showDeleted;
        if (showDeleted) {
          $(this).html('<i class="fas fa-eye-slash"></i> Hide Deleted Users');
          $(this).removeClass('btn-info').addClass('btn-warning');
        } else {
          $(this).html('<i class="fas fa-eye"></i> Show Deleted Users');
          $(this).removeClass('btn-warning').addClass('btn-info');
        }
        initDataTable();
      });

      // Save User
      $('#userSubmit').click(function() {
        const formData = {
          name: $('#user_name').val(),
          email: $('#user_email').val(),
          password: $('#user_password').val(),
          confirm_password: $('#user_confirm_password').val()
        };

        // Validation
        if (!formData.name || !formData.email || !formData.password) {
          Swal.fire('Error', 'Please fill in all required fields', 'error');
          return;
        }

        if (formData.password !== formData.confirm_password) {
          Swal.fire('Error', 'Passwords do not match', 'error');
          return;
        }

        // Remove confirm_password from data sent to server
        delete formData.confirm_password;

        $.ajax({
          url: '/api/users/register',
          type: 'POST',
          data: formData,
          success: function(response) {
            if (response.success) {
              Swal.fire('Success', 'User created successfully', 'success');
              $('#userModal').modal('hide');
              table.ajax.reload();
            } else {
              Swal.fire('Error', response.message || 'Failed to create user', 'error');
            }
          },
          error: function(xhr) {
            const response = xhr.responseJSON;
            Swal.fire('Error', response?.message || 'Failed to create user', 'error');
          }
        });
      });

      // Edit User
      $(document).on('click', '.edit-user', function() {
        const userId = $(this).data('id');
        currentUserId = userId;
        isEditMode = true;

        $.ajax({
          url: `/api/users/${userId}`,
          type: 'GET',
          success: function(response) {
            if (response.success) {
              const user = response.data;
              $('#user_name').val(user.name);
              $('#user_email').val(user.email);
              $('#user_password').val(''); // Don't show password
              $('#user_confirm_password').val('');
              $('#userModalLabel').text('Edit User');
              $('#userSubmit').hide();
              $('#userUpdate').show();
              $('#userModal').modal('show');
            }
          },
          error: function() {
            Swal.fire('Error', 'Failed to fetch user details', 'error');
          }
        });
      });

      // Update User
      $('#userUpdate').click(function() {
        const formData = {
          name: $('#user_name').val(),
          email: $('#user_email').val()
        };

        // Only include password if it's provided
        if ($('#user_password').val()) {
          if ($('#user_password').val() !== $('#user_confirm_password').val()) {
            Swal.fire('Error', 'Passwords do not match', 'error');
            return;
          }
          formData.password = $('#user_password').val();
        }

        $.ajax({
          url: `/api/users/${currentUserId}`,
          type: 'PUT',
          data: formData,
          success: function(response) {
            if (response.success) {
              Swal.fire('Success', 'User updated successfully', 'success');
              $('#userModal').modal('hide');
              table.ajax.reload();
            } else {
              Swal.fire('Error', response.message || 'Failed to update user', 'error');
            }
          },
          error: function(xhr) {
            const response = xhr.responseJSON;
            Swal.fire('Error', response?.message || 'Failed to update user', 'error');
          }
        });
      });

      // Delete User
      $(document).on('click', '.delete-user', function() {
        const userId = $(this).data('id');
        
        Swal.fire({
          title: 'Are you sure?',
          text: 'This will deactivate the user account',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: `/api/users/${userId}`,
              type: 'DELETE',
              success: function(response) {
                if (response.success) {
                  Swal.fire('Deleted!', 'User has been deactivated', 'success');
                  table.ajax.reload();
                } else {
                  Swal.fire('Error', response.message || 'Failed to delete user', 'error');
                }
              },
              error: function() {
                Swal.fire('Error', 'Failed to delete user', 'error');
              }
            });
          }
        });
      });

      // Restore User
      $(document).on('click', '.restore-user', function() {
        const userId = $(this).data('id');
        
        Swal.fire({
          title: 'Restore User?',
          text: 'This will reactivate the user account',
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#28a745',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, restore it!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: `/api/users/restore/${userId}`,
              type: 'PUT',
              success: function(response) {
                if (response.success) {
                  Swal.fire('Restored!', 'User has been reactivated', 'success');
                  table.ajax.reload();
                } else {
                  Swal.fire('Error', response.message || 'Failed to restore user', 'error');
                }
              },
              error: function() {
                Swal.fire('Error', 'Failed to restore user', 'error');
              }
            });
          }
        });
      });

      // View Profile
      $(document).on('click', '.view-profile', function() {
        const userId = $(this).data('id');
        
        $.ajax({
          url: `/api/users/customers/${userId}`,
          type: 'GET',
          success: function(response) {
            if (response.success) {
              const profile = response.data;
              let profileHtml = `
                <div class="row">
                  <div class="col-md-4 text-center">
                    ${profile.image_path ? 
                      `<img src="${profile.image_path}" class="img-fluid rounded-circle mb-3" style="max-width: 150px;">` : 
                      '<div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 150px; height: 150px;"><i class="fas fa-user fa-3x text-muted"></i></div>'
                    }
                  </div>
                  <div class="col-md-8">
                    <h5>Profile Information</h5>
                    <table class="table table-borderless">
                      <tr><th>Title:</th><td>${profile.title || 'N/A'}</td></tr>
                      <tr><th>First Name:</th><td>${profile.fname || 'N/A'}</td></tr>
                      <tr><th>Last Name:</th><td>${profile.lname || 'N/A'}</td></tr>
                      <tr><th>Address:</th><td>${profile.addressline || 'N/A'}</td></tr>
                      <tr><th>Town:</th><td>${profile.town || 'N/A'}</td></tr>
                      <tr><th>Phone:</th><td>${profile.phone || 'N/A'}</td></tr>
                    </table>
                  </div>
                </div>
              `;
              $('#profileContent').html(profileHtml);
            } else {
              $('#profileContent').html('<p class="text-muted">No profile information available</p>');
            }
            $('#profileModal').modal('show');
          },
          error: function() {
            $('#profileContent').html('<p class="text-danger">Failed to load profile information</p>');
            $('#profileModal').modal('show');
          }
        });
      });
    });
  </script>
</body>
</html>