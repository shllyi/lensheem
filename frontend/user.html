<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>User Management</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap4.min.css"
    integrity="sha512-PT0RvABaDhDQugEbpNMwgYBCnGCiTZMh9yOzUsJHDgl/dMhD9yjHAwoumnUk3JydV3QTcIkNDuN40CJxik5+WQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/buttons/2.3.5/css/buttons.dataTables.min.css" rel="stylesheet" />

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/datatables.net-buttons-bs5/2.3.6/buttons.bootstrap5.min.css"
    integrity="sha512-vWTrt2A9iAn2pK8hNZS26YZRDDUvLiOfyL+MmBEXJizrigtxnpLuLrLOOMm+pcrUJFzGssUwoS6Gofp+TT2deQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.css"
    integrity="sha512-fjO3Vy3QodX9c6G9AUmr6WuIaEPdGRxBjD7gjatG5gGylzYyrEq3U0q+smkG6CwIY0L8XALRFHh4KPHig0Q1ug=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"
    integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"
    integrity="sha512-BkpSL20WETFylMrcirBahHfSnY++H2O1W+UnEEO4yNIl+jI2+zowyoGJpbtk6bx97fBXf++WJHSSK2MV4ghPcg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.5/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.5/js/buttons.bootstrap4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.5/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"
    integrity="sha512-RdSPYh1WA6BF0RhpisYJVYkOyTzK4HwofJ3Q7ivt/jkpW6Vc8AurL1R+4AUcvn9IwEKAPm/fk7qFZW3OuiUDeg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js"
    integrity="sha512-LGHBR+kJ5jZSIzhhdfytPoEHzgaYuTRifq9g5l6ja6/k9NAOsAi5dQh4zQF6JIRB8cAYxTRedERUF+97/KuivQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    .role-badge, .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .role-admin {
      background-color: #dc3545;
      color: white;
    }
    
    .role-user {
      background-color: #28a745;
      color: white;
    }
    
    .status-active {
      background-color: #28a745;
      color: white;
    }
    
    .status-deactivated {
      background-color: #6c757d;
      color: white;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .action-buttons .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    
    .dataTables_wrapper .dt-buttons {
      margin-bottom: 10px;
    }
    
    .dataTables_wrapper .dt-buttons .btn {
      margin-right: 5px;
    }
    
    .table-responsive {
      margin-top: 20px;
    }
    
    .search-container {
      max-width: 300px;
    }
  </style>
</head>

<body>

  <div id="header"></div>


  <div class="container-fluid py-4">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">User Management</h3>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-4">
          <button type="button" class="btn btn-success" data-toggle="modal" data-target="#userModal">
            <i class="fas fa-plus"></i> Add New User
          </button>

          <div class="search-container">
            <div class="input-group">
              <input type="text" id="userSearch" class="form-control" placeholder="Search users...">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table id="utable" class="table table-striped table-bordered table-hover" style="width:100%">
            <thead class="thead-dark">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>AddressLine</th>
                <th>Town</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ubody">

            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="uform">
        <div class="modal-header">
          <h5 class="modal-title" id="userModalLabel">Add New User</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="user_name">Name *</label>
            <input type="text" class="form-control" id="user_name" name="name" required>
          </div>
          <div class="form-group">
            <label for="user_email">Email *</label>
            <input type="email" class="form-control" id="user_email" name="email" required>
          </div>
          <div class="form-group">
            <label for="user_password">Password *</label>
            <input type="password" class="form-control" id="user_password" name="password" required>
          </div>
          <div class="form-group">
            <label for="user_addressline">Address</label>
            <input type="text" class="form-control" id="user_addressline" name="addressline">
          </div>
          <div class="form-group">
            <label for="user_town">Town</label>
            <input type="text" class="form-control" id="user_town" name="town">
          </div>
          <div class="form-group">
            <label for="user_phone">Phone</label>
            <input type="text" class="form-control" id="user_phone" name="phone">
          </div>
          <div class="form-group">
            <label for="user_role">Role *</label>
            <select class="form-control" id="user_role" name="role" required>
              <option value="">Select Role</option>
              <option value="admin">Admin</option>
              <option value="user">User</option>
            </select>
          </div>
          <div id="role-description" class="text-muted small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="userSubmit">Add User</button>
          <button type="button" class="btn btn-warning" id="userUpdate" style="display: none;">Update User</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Role Change Modal -->
  <div class="modal fade" id="roleModal" tabindex="-1" role="dialog" aria-labelledby="roleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="roleModalLabel">Change User Role</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="roleForm">
            <div class="form-group">
              <label for="new_role">Select New Role *</label>
              <select class="form-control" id="new_role" name="new_role" required>
                <option value="">Select Role</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
              </select>
            </div>
            <input type="hidden" id="role_user_id" name="role_user_id">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="roleSubmit">Change Role</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Change Modal -->
  <div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="statusModalLabel">Change User Status</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="statusForm">
            <div class="form-group">
              <label for="new_status">Select New Status *</label>
              <select class="form-control" id="new_status" name="new_status" required>
                <option value="">Select Status</option>
                <option value="active">Active</option>
                <option value="deactivated">Deactivated</option>
              </select>
            </div>
            <input type="hidden" id="status_user_id" name="status_user_id">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-info" id="statusSubmit">Change Status</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<script>
    $(document).ready(function () {

      $('#header').load('/header_admin.html', function () {
          renderCart();
        });

    const url = 'http://localhost:3000/';
  $('#utable').DataTable({
        ajax: {
            url: `${url}api/users/users`,
            dataSrc: function(json) {
                // Handle different response formats
                if (json.rows) return json.rows;
                if (json.data) return json.data;
                if (Array.isArray(json)) return json;
                return [];
            },
            error: function (xhr, error, thrown) {
                console.error('DataTable loading error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Failed to load user data. Please check your connection and try again.',
                });
            }
        },
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'pdf',
                className: 'btn btn-danger btn-sm',
                title: 'Users Report'
            },
            {
                extend: 'excel',
                className: 'btn btn-success btn-sm',
                title: 'Users Report'
            },
            {
                text: 'Add User',
                className: 'btn btn-primary btn-sm',
                action: function (e, dt, node, config) {
                    $("#uform").trigger("reset");
                    $('#userModal').modal('show');
                    $('#userUpdate').hide();
                    $('#userSubmit').show();
                    $('#userId').remove();
                    $('#role-description').text('');
                    $('#userModalLabel').text('Add New User');
                    $('#user_password').prop('required', true);
                }
            }
        ],
        columns: [
            { data: 'id' },
            { data: 'name' },
            { data: 'email' },
            { data: 'addressline' },
            { data: 'town' },
            { data: 'phone' },
            {
                data: 'role',
                render: function (data, type, row) {
                    const roleClass = `role-${data.toLowerCase()}`;
                    return `<span class="role-badge ${roleClass}">${data.charAt(0).toUpperCase() + data.slice(1)}</span>`;
                }
            },
            {
                data: 'status',
                render: function (data, type, row) {
                    const statusClass = `status-${data.toLowerCase()}`;
                    return `<span class="status-badge ${statusClass}">${data.charAt(0).toUpperCase() + data.slice(1)}</span>`;
                }
            },
            {
                data: null,
                render: function (data, type, row) {
                    return `
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary editBtn" data-id="${data.id}" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-warning roleBtn" data-id="${data.id}" title="Change Role">
                                <i class="fas fa-user-tag"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary statusBtn" data-id="${data.id}" title="Change Status">
                                <i class="fas fa-toggle-on"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        responsive: true,
        processing: true,
        language: {
            processing: "Loading users..."
        }
    });

    // Show role description when role is selected
    $('#user_role').on('change', function () {
        const selectedOption = $(this).find('option:selected');
        const description = selectedOption.data('description');

        if (description) {
            $('#role-description').text(`Role: ${description}`);
        } else {
            $('#role-description').text('');
        }
    });

    // Submit new user
    $("#userSubmit").on('click', function (e) {
        e.preventDefault();

        if (!$('#uform')[0].checkValidity()) {
            $('#uform')[0].reportValidity();
            return;
        }

        var data = $('#uform')[0];
        let formData = new FormData(data);

        // Convert FormData to regular object for JSON
        let userData = {};
        for (var pair of formData.entries()) {
            userData[pair[0]] = pair[1];
        }

        // Show loading
        Swal.fire({
            title: 'Creating User...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            method: "POST",
            url: `${url}api/users/users`,
            data: JSON.stringify(userData),
            contentType: 'application/json',
            dataType: "json",
            success: function (data) {
                console.log(data);
                $("#userModal").modal("hide");
                var $utable = $('#utable').DataTable();
                $utable.ajax.reload();

                Swal.fire({
                    icon: 'success',
                    title: 'User Added!',
                    text: 'New user has been added successfully.',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseJSON);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'Failed to add user. Please try again.',
                });
            }
        });
    });

    // Edit user button click handler
    $('#utable tbody').on('click', 'button.editBtn', function (e) {
        e.preventDefault();
        $('#userId').remove();
        $("#uform").trigger("reset");

        var id = $(this).data('id');
        console.log(id);
        $('#userModal').modal('show');
        $('<input>').attr({ type: 'hidden', id: 'userId', name: 'user_id', value: id }).appendTo('#uform');

        $('#userSubmit').hide();
        $('#userUpdate').show();
        $('#userModalLabel').text('Edit User');

        // Show loading
        Swal.fire({
            title: 'Loading User Data...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            method: "GET",
            url: `${url}api/users/users/${id}`,
            dataType: "json",
            success: function (data) {
                const { result } = data;
                console.log(result);

                Swal.close();


                const user = result[0] || result;
                $('#user_name').val(user.name);
                $('#user_email').val(user.email);
                $('#user_phone').val(user.phone);
                $('#user_town').val(user.town);
                $('#user_addressline').val(user.addressline);
                $('#user_role').val(user.role);
                // Don't populate password field for security
                $('#user_password').val('').prop('required', false);
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseJSON);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'Failed to load user data.',
                });
            }
        });
    });

    // Update user
    $("#userUpdate").on('click', function (e) {
        e.preventDefault();

        if (!$('#uform')[0].checkValidity()) {
            $('#uform')[0].reportValidity();
            return;
        }

        var id = $('#userId').val();
        console.log(id);
        var table = $('#utable').DataTable();

        var data = $('#uform')[0];
        let formData = new FormData(data);

        // Convert FormData to regular object for JSON
        let userData = {};
        for (var pair of formData.entries()) {
            userData[pair[0]] = pair[1];
        }

        // Show loading
        Swal.fire({
            title: 'Updating User...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            method: "PUT",
            url: `${url}api/users/users/${id}`,
            data: JSON.stringify(userData),
            contentType: 'application/json',
            dataType: "json",
            success: function (data) {
                console.log(data);
                $('#userModal').modal("hide");
                table.ajax.reload();

                Swal.fire({
                    icon: 'success',
                    title: 'User Updated!',
                    text: 'User information has been updated successfully.',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseJSON);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'Failed to update user. Please try again.',
                });
            }
        });
    });

    // Change role button click handler
    $('#utable tbody').on('click', 'button.roleBtn', function (e) {
        e.preventDefault();
        var id = $(this).data('id');
        $('#role_user_id').val(id);
        $('#roleModal').modal('show');
    });

    // Submit role change
    $("#roleSubmit").on('click', function (e) {
        e.preventDefault();

        if (!$('#roleForm')[0].checkValidity()) {
            $('#roleForm')[0].reportValidity();
            return;
        }

        var userId = $('#role_user_id').val();
        var newRole = $('#new_role').val();
        var table = $('#utable').DataTable();

        // Show loading
        Swal.fire({
            title: 'Updating Role...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            method: "PUT",
            url: `${url}api/users/users/${userId}/role`,
            data: JSON.stringify({ role: newRole }),
            contentType: 'application/json',
            dataType: "json",
            success: function (data) {
                console.log(data);
                $('#roleModal').modal("hide");
                table.ajax.reload();

                Swal.fire({
                    icon: 'success',
                    title: 'Role Updated!',
                    text: 'User role has been updated successfully.',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseJSON);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'Failed to update role. Please try again.',
                });
            }
        });
    });

    // Change status button click handler
    $('#utable tbody').on('click', 'button.statusBtn', function (e) {
        e.preventDefault();
        var id = $(this).data('id');
        $('#status_user_id').val(id);
        $('#statusModal').modal('show');
    });

    // Submit status change
    $("#statusSubmit").on('click', function (e) {
        e.preventDefault();

        if (!$('#statusForm')[0].checkValidity()) {
            $('#statusForm')[0].reportValidity();
            return;
        }

        var userId = $('#status_user_id').val();
        var newStatus = $('#new_status').val();
        var table = $('#utable').DataTable();

        // Show loading
        Swal.fire({
            title: 'Updating Status...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            method: "PUT",
            url: `${url}api/users/users/${userId}/status`,
            data: JSON.stringify({ status: newStatus }),
            contentType: 'application/json',
            dataType: "json",
            success: function (data) {
                console.log(data);
                $('#statusModal').modal("hide");
                table.ajax.reload();

                Swal.fire({
                    icon: 'success',
                    title: 'Status Updated!',
                    text: 'User status has been updated successfully.',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseJSON);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: xhr.responseJSON?.error || 'Failed to update status. Please try again.',
                });
            }
        });
    });

    // // Delete user button click handler
    // $('#utable tbody').on('click', 'button.deleteBtn', function (e) {
    //     e.preventDefault();
    //     var table = $('#utable').DataTable();
    //     var id = $(this).data('id');
    //     var $row = $(this).closest('tr');
    //     console.log(id);

    //     Swal.fire({
    //         title: 'Are you sure?',
    //         text: 'You won\'t be able to revert this!',
    //         icon: 'warning',
    //         showCancelButton: true,
    //         confirmButtonColor: '#d33',
    //         cancelButtonColor: '#3085d6',
    //         confirmButtonText: 'Yes, delete it!'
    //     }).then((result) => {
    //         if (result.isConfirmed) {
    //             // Show loading
    //             Swal.fire({
    //                 title: 'Deleting User...',
    //                 allowOutsideClick: false,
    //                 didOpen: () => {
    //                     Swal.showLoading();
    //                 }
    //             });

    //             $.ajax({
    //                 method: "DELETE",
    //                 : `${url}api/users/users/${id}`,
    //                 dataType: "json",
    //                 success: function (data) {
    //                     console.log(data);
    //                     table.ajax.reload();

    //                     Swal.fire({
    //                         icon: 'success',
    //                         title: 'Deleted!',
    //                         text: 'User has been deleted successfully.',
    //                         timer: 2000,
    //                         showConfirmButton: false
    //                     });
    //                 },
    //                 error: function (xhr, status, error) {
    //                     console.log(xhr.responseJSON);
    //                     Swal.fire({
    //                         icon: 'error',
    //                         title: 'Error!',
    //                         text: xhr.responseJSON?.error || 'Failed to delete user. Please try again.',
    //                     });
    //                 }
    //             });
    //         }
    //     });
    // });

    // Search functionality
    $('#userSearch').on('keyup', function () {
        var table = $('#utable').DataTable();
        table.search(this.value).draw();
    });

    // Search button functionality
    $('#searchButton').on('click', function () {
        var table = $('#utable').DataTable();
        table.search($('#userSearch').val()).draw();
    });

    // Reset forms when modals are hidden
    $('#userModal').on('hidden.bs.modal', function () {
        $('#uform')[0].reset();
        $('#userSubmit').show();
        $('#userUpdate').hide();
        $('#userModalLabel').text('Add New User');
        $('#userId').remove();
        $('#role-description').text('');
        // Reset password field requirement
        $('#user_password').prop('required', true);
    });

    $('#roleModal').on('hidden.bs.modal', function () {
        $('#roleForm')[0].reset();
    });

    $('#statusModal').on('hidden.bs.modal', function () {
        $('#statusForm')[0].reset();
    });
});
</script>